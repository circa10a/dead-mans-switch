<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dead Man">
    <link rel="apple-touch-icon" href="/images/purple-skull-512-maskable-square.png">
    <link rel="icon" type="image/png" href="/images/favicon.ico">
    <link href="/static/css/tailwind.css" rel="stylesheet">

    <title>Dead Man's Switch</title>
    <script defer src="/static/js/alpine.min.js"></script>
    <style>
        [x-cloak] {
            display: none !important;
        }

        body {
            background-color: #f3f4f6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Deep nocturnal background */
        .dark body {
            background-color: #050505;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* Opaque charcoal glass for better contrast */
        .dark .glass {
            background: rgba(15, 15, 15, 0.9);
        }

        .disabled-card-container {
            background: rgba(0, 0, 0, 0.03) !important;
            border-color: rgba(0, 0, 0, 0.05) !important;
        }

        .dark .disabled-card-container {
            background: rgba(255, 255, 255, 0.01) !important;
            border-color: rgba(255, 255, 255, 0.03) !important;
        }

        input[type=range]::-webkit-slider-runnable-track {
            background: rgba(0, 0, 0, 0.1);
            height: 6px;
            border-radius: 3px;
        }

        .dark input[type=range]::-webkit-slider-runnable-track {
            background: rgba(255, 255, 255, 0.05);
        }

        input[type=range]::-webkit-slider-thumb {
            margin-top: -5px;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #6366f1;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
        }
    </style>
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
</head>

<body class="text-gray-900 dark:text-gray-300 antialiased" x-data="app()">
    <template x-if="!isSecure && showInsecureWarning">
        <div
            class="bg-indigo-600 text-white px-5 py-2.5 text-[10px] font-black uppercase tracking-[0.2em] flex justify-between items-center z-[60] relative shadow-lg shadow-indigo-900/30">
            <div class="flex items-center gap-2">
                <svg class="w-3.5 h-3.5 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <span>Notifications require HTTPS</span>
            </div>
            <button @click="showInsecureWarning = false" class="bg-white/15 hover:bg-white/25 px-2.5 py-1 rounded-md transition-colors text-white/90">Dismiss</button>
        </div>
    </template>

    <div x-show="!isOnline" x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="-translate-y-full" x-transition:enter-end="translate-y-0"
        x-transition:leave="transition ease-in duration-200" x-transition:leave-start="translate-y-0"
        x-transition:leave-end="-translate-y-full"
        class="fixed top-0 left-0 right-0 z-[100] bg-red-700 text-white text-[10px] font-black uppercase tracking-[0.2em] py-3 text-center shadow-lg border-b border-red-900">
        <div class="flex items-center justify-center gap-2">
            <span class="relative flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-white"></span>
            </span>
            Connection Lost — Reconnecting
        </div>
    </div>

    <header class="sticky top-0 z-40 border-b border-gray-200 dark:border-white/5 glass transition-colors duration-300">
        <div class="max-w-3xl mx-auto px-6 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div
                    class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center shadow-lg shadow-indigo-900/40">
                    <img src="/images/purple-skull-512-rounded.png" alt="App Icon" class="w-5 h-5 object-contain">
                </div>
                <h1 class="font-bold text-lg tracking-tight text-gray-900 dark:text-white/90">Dead Man's Switch</h1>
            </div>
            <div class="flex items-center gap-3">
                <button type="button" @click="toggleTheme()"
                    class="p-2 rounded-full transition-all text-gray-500 hover:bg-black/5 dark:text-gray-400 dark:hover:bg-white/5 active:scale-95 flex items-center justify-center">
                    <svg x-show="!darkMode" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                    <svg x-show="darkMode" x-cloak class="w-5 h-5" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </button>

                <template x-if="authEnabled && accessToken">
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500 dark:text-gray-400 hidden sm:inline truncate max-w-[120px]" x-text="userName"></span>
                        <button @click="logout()"
                            class="p-2 rounded-full transition-all text-gray-500 hover:bg-red-500/10 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400 active:scale-95"
                            title="Logout">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                        </button>
                    </div>
                </template>

                <button @click="forcePermission()" x-show="!authEnabled || accessToken" class="p-2 rounded-full transition-all active:scale-95" :class="{
                        'text-indigo-600 dark:text-indigo-400 bg-indigo-500/10 animate-pulse': notifyStatus === 'default',
                        'text-indigo-500 dark:text-indigo-400 bg-indigo-500/10': notifyStatus === 'granted',
                        'text-gray-500 dark:text-gray-700 bg-black/5 dark:bg-white/5': notifyStatus === 'denied'
                    }">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                </button>

                <button @click="openCreateModal()" x-show="!authEnabled || accessToken"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white dark:bg-indigo-600 dark:hover:bg-indigo-500 px-4 py-2 rounded-full text-xs font-bold transition-all shadow-md">+
                    New</button>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 py-6 pb-32 min-h-screen">
        <!-- Login screen when auth is enabled but user not authenticated -->
        <template x-if="authEnabled && !accessToken && authReady">
            <div class="flex flex-col items-center justify-center min-h-[60vh] gap-6">
                <div class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center shadow-2xl shadow-indigo-900/40">
                    <img src="/images/purple-skull-512-rounded.png" alt="App Icon" class="w-12 h-12 object-contain">
                </div>
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Sign in required</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Authenticate to manage your dead man's switches</p>
                </div>
                <button @click="login()"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white dark:bg-indigo-600 dark:hover:bg-indigo-500 px-8 py-3 rounded-full text-sm font-bold transition-all shadow-lg shadow-indigo-900/30 active:scale-95 flex items-center gap-2">
                    <template x-if="providerName === 'Google'">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" />
                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" />
                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                        </svg>
                    </template>
                    <template x-if="providerName !== 'Google'">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                        </svg>
                    </template>
                    <span x-text="'Sign in with ' + providerName"></span>
                </button>
            </div>
        </template>

        <div class="space-y-4" x-show="!authEnabled || accessToken">
            <template x-for="(sw, index) in switches" :key="sw.id">
                <div draggable="true" @dragstart="dragStart($event, index)" @dragover.prevent
                    @drop="drop($event, index)" @dragend="dragEnd()"
                    class="glass border border-gray-200 dark:border-white/10 rounded-2xl p-5 shadow-sm dark:shadow-2xl relative overflow-hidden group transition-all duration-300 cursor-grab active:cursor-grabbing"
                    :class="[
                        sw.status === 'disabled' ? 'disabled-card-container' : '',
                        draggingIndex === index ? 'opacity-20 scale-95 border-dashed border-indigo-500' : ''
                    ]">

                    <div :class="sw.status === 'disabled' ? '' : (sw.status === 'triggered' || sw.status === 'failed' ? 'bg-red-500/5' : (isPending(sw) ? 'bg-amber-500/10 animate-pulse' : (isExpiringSoon(sw.triggerAt) ? 'bg-orange-500/10 animate-pulse' : 'bg-emerald-500/5')))"
                        class="absolute inset-0 pointer-events-none transition-colors duration-1000"></div>

                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-2">
                                <template x-if="sw.status === 'failed'">
                                    <div class="flex items-center gap-1">
                                        <span class="text-[10px] font-black px-2 py-0.5 rounded-md uppercase tracking-widest border text-red-500 bg-red-500/10 border-red-500/20">Failed</span>
                                        <button type="button" @click="openFailureModal(sw)"
                                            :title="sw.failureReason ? 'Click to view failure reason' : 'No failure reason available'"
                                            class="text-red-500 hover:text-red-600 dark:hover:text-red-400 transition-colors p-0.5 flex items-center justify-center active:scale-90"
                                            aria-label="View failure reason">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                                            </svg>
                                        </button>
                                    </div>
                                </template>
                                <span x-show="sw.status !== 'failed'"
                                    :class="sw.status === 'disabled' ? 'text-gray-500 bg-gray-500/10 border-gray-500/20' : 
                                    (sw.status === 'triggered' ? 'text-red-500 bg-red-500/10 border-red-500/20' : 
                                    (isPending(sw) ? 'text-amber-500 bg-amber-500/10 border-amber-500/20' : 
                                    (isExpiringSoon(sw.triggerAt) ? 'text-orange-500 bg-orange-500/10 border-orange-500/20' : 'text-emerald-400 bg-emerald-500/10 border-emerald-500/20')))"
                                    class="text-[10px] font-black px-2 py-0.5 rounded-md uppercase tracking-widest border"
                                    x-text="sw.status === 'disabled' ? 'Disabled' : (sw.status === 'triggered' ? 'Triggered' : (isPending(sw) ? 'Pending' : (isExpiringSoon(sw.triggerAt) ? 'Soon' : 'Active')))">
                                </span>

                                <template x-if="isReminderEnabled(sw)">
                                    <div class="flex items-center justify-center text-indigo-500 dark:text-indigo-400 animate-pulse"
                                        title="Push Notifications Enabled">
                                        <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 24 24">
                                            <path
                                                d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z" />
                                        </svg>
                                    </div>
                                </template>
                            </div>
                            <div class="flex gap-2">
                                <button x-show="sw.status !== 'disabled'" @click="disableSw(sw.id)"
                                    class="p-2 text-gray-500 hover:text-amber-500 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </button>
                                <button x-show="!sw.encrypted" @click="openEditModal(sw)"
                                    class="p-2 text-gray-500 hover:text-indigo-400 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path
                                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                                            stroke-width="2" stroke-linecap="round"></path>
                                    </svg>
                                </button>
                                <button x-show="!sw.encrypted && sw.status !== 'disabled'" @click="updateLocation(sw)"
                                    class="p-2 text-gray-500 hover:text-indigo-400 transition-colors"
                                    :class="{ 'opacity-50 pointer-events-none animate-pulse': locatingId === sw.id }"
                                    title="Update with current location">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
                                    </svg>
                                </button>
                                <button @click="deleteSw(sw.id)"
                                    class="p-2 text-gray-500 hover:text-red-500 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                            stroke-width="2" stroke-linecap="round"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div :class="sw.status === 'disabled' ? 'opacity-30 grayscale' : ''">
                            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-1 truncate"
                                x-text="sw.encrypted ? '••••••••' : sw.message"></h2>

                            <div class="flex flex-wrap gap-1.5 mb-4">
                                <template x-for="uri in (sw.notifiers || [])" :key="uri">
                                    <span
                                        class="px-2 py-0.5 bg-indigo-500/10 border border-indigo-500/10 text-indigo-400 rounded text-[9px] font-bold uppercase tracking-wider"
                                        x-text="uri.includes('://') ? uri.split('://')[0] : 'Secret'">
                                    </span>
                                </template>
                            </div>

                            <div
                                class="flex justify-between items-center bg-black/10 dark:bg-black/40 rounded-xl p-3 border border-black/5 dark:border-white/5">
                                <div>
                                    <span
                                        class="text-[9px] text-gray-500 uppercase font-bold block mb-0.5">Interval</span>
                                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400"
                                        x-text="sw.checkInInterval"></span>
                                </div>
                                <div class="text-right">
                                    <span
                                        class="text-[9px] text-gray-500 uppercase font-bold block mb-0.5">Remaining</span>
                                    <span
                                        :class="sw.status === 'disabled' ? 'text-gray-600' : (sw.status === 'triggered' || sw.status === 'failed' ? 'text-red-500' : (isPending(sw) ? 'text-amber-500' : (isExpiringSoon(sw.triggerAt) ? 'text-orange-500' : 'text-emerald-400')))"
                                        class="text-sm font-mono font-bold block"
                                        x-text="sw.status === 'disabled' ? 'PAUSED' : (sw.status === 'triggered' ? 'TRIGGERED' : (sw.status === 'failed' ? 'FAILED' : getCountdown(sw.triggerAt)))"></span>
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-gray-200 dark:border-white/5 mt-4">
                            <button @click="resetSw(sw.id)" :disabled="resettingId === sw.id"
                                :class="resettingId === sw.id ? 'bg-emerald-600 text-white scale-[0.97]' : (sw.status === 'disabled' ? 'bg-gray-100 dark:bg-white/5 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-white/10' : 'bg-emerald-500/10 text-emerald-500 border-emerald-500/20 hover:bg-emerald-500/20')"
                                class="w-full py-4 border border-transparent text-[11px] font-black uppercase tracking-[0.2em] rounded-xl transition-all duration-300 flex items-center justify-center gap-2 relative active:scale-95">
                                <span x-show="resettingId !== sw.id"
                                    x-text="(sw.status === 'disabled' || sw.status === 'triggered' ) ? 'Enable' : 'Check In'"></span>
                                <span x-show="resettingId === sw.id" class="flex items-center gap-2">
                                    <svg class="w-4 h-4 animate-bounce" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path d="M5 13l4 4L19 7" stroke-width="3" stroke-linecap="round"></path>
                                    </svg>
                                    <span x-text="sw.status === 'disabled' ? 'Enabled' : 'Checked In'"></span>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </main>

    <div x-show="authErrorOpen" x-cloak class="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4">
        <div x-show="authErrorOpen" x-transition.opacity @click="authErrorOpen = false"
            class="fixed inset-0 bg-gray-900/50 dark:bg-black/90 backdrop-blur-sm"></div>
        <div x-show="authErrorOpen" x-transition:enter="transition ease-out duration-300 transform"
            x-transition:enter-start="translate-y-full sm:scale-95"
            class="relative w-full max-w-lg bg-white dark:bg-[#121212] rounded-t-3xl sm:rounded-3xl border border-gray-200 dark:border-white/10 p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-red-500/10 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 16.5c-.77.833.192 2.5 1.732 2.5z" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-black text-gray-900 dark:text-white">Connection Error</h3>
                    <p class="text-[10px] text-gray-500 dark:text-gray-400 uppercase font-medium tracking-wider">Authentication Provider</p>
                </div>
                <button type="button" @click="authErrorOpen = false"
                    class="ml-auto text-gray-500 text-xs font-bold uppercase">Close</button>
            </div>
            <div class="bg-red-500/5 border border-red-500/10 rounded-2xl p-5 text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                <p x-text="authErrorMessage"></p>
            </div>
            <button @click="authErrorOpen = false; login()"
                class="w-full mt-6 bg-indigo-600 hover:bg-indigo-700 text-white font-black py-3.5 rounded-2xl transition-all active:scale-95 text-xs uppercase tracking-widest">Retry</button>
        </div>
    </div>

    <div x-show="failureModalOpen" x-cloak class="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4">
        <div x-show="failureModalOpen" x-transition.opacity @click="failureModalOpen = false"
            class="fixed inset-0 bg-gray-900/50 dark:bg-black/90 backdrop-blur-sm"></div>
        <div x-show="failureModalOpen" x-transition:enter="transition ease-out duration-300 transform"
            x-transition:enter-start="translate-y-full sm:scale-95"
            class="relative w-full max-w-lg bg-white dark:bg-[#121212] rounded-t-3xl sm:rounded-3xl border border-gray-200 dark:border-white/10 p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex items-center gap-3 mb-6">
                <div>
                    <h3 class="text-lg font-black text-gray-900 dark:text-white">Failure Reason</h3>
                    <p class="text-[10px] text-gray-500 dark:text-gray-400 uppercase font-medium" x-text="selectedFailureSw?.message"></p>
                </div>
                <button type="button" @click="failureModalOpen = false"
                    class="ml-auto text-gray-500 text-xs font-bold uppercase">Close</button>
            </div>
            <div class="bg-red-500/5 border border-red-500/10 rounded-2xl p-5 text-sm leading-relaxed text-gray-700 dark:text-gray-300">
                <p x-text="selectedFailureSw?.failureReason || 'No failure reason available'" class="whitespace-pre-wrap break-words"></p>
            </div>
        </div>
    </div>

    <div x-show="openModal" x-cloak class="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4">
        <div x-show="openModal" x-transition.opacity @click="openModal = false"
            class="fixed inset-0 bg-gray-900/50 dark:bg-black/90 backdrop-blur-sm"></div>
        <div x-show="openModal" x-transition:enter="transition ease-out duration-300 transform"
            x-transition:enter-start="translate-y-full sm:scale-95"
            class="relative w-full max-w-lg bg-white dark:bg-[#121212] rounded-t-3xl sm:rounded-3xl border border-gray-200 dark:border-white/10 p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
            <form @submit.prevent="saveSw">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-black text-gray-900 dark:text-white"
                        x-text="editingId ? 'Edit Switch' : 'New Switch'"></h3>
                    <button type="button" @click="openModal = false"
                        class="text-gray-500 text-xs font-bold uppercase">Close</button>
                </div>

                <template x-if="isReminderEnabled(sw)">
                    <div
                        class="mb-6 p-4 bg-emerald-50 dark:bg-emerald-500/10 border border-emerald-200 dark:border-emerald-500/20 rounded-2xl flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-2.5 h-2.5 bg-emerald-500 rounded-full animate-pulse shadow-[0_0_8px_rgba(16,185,129,0.6)]">
                            </div>
                            <div>
                                <p
                                    class="text-[10px] font-black text-emerald-600 dark:text-emerald-400 uppercase tracking-widest">
                                    Push
                                    Notifications On</p>
                                <p
                                    class="text-[9px] text-emerald-600/60 dark:text-emerald-400/60 uppercase font-medium">
                                    Ready for reminders</p>
                            </div>
                        </div>
                    </div>
                </template>

                <div class="space-y-5">
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[10px] font-bold text-gray-500 uppercase block">Message</label>
                        </div>
                        <input x-model="form.message" type="text" required
                            class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl p-4 text-gray-900 dark:text-white outline-none focus:border-indigo-500">
                    </div>

                    <div>
                        <label class="text-[10px] font-bold text-gray-500 uppercase block mb-1">Check-In Interval (e.g.
                            24h)</label>
                        <input x-model="form.checkInInterval" type="text" required
                            class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl p-4 text-gray-900 dark:text-white outline-none focus:border-indigo-500">
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[10px] font-bold text-gray-500 uppercase block">Notifiers (one per
                                line)</label>
                            <a href="https://caleblemoine.dev/shoutrrr/latest/services/overview/" target="_blank"
                                class="text-[9px] font-bold text-indigo-500 dark:text-indigo-400 hover:text-indigo-600 dark:hover:text-indigo-300 uppercase underline decoration-indigo-500/30 underline-offset-2">Docs
                                &rarr;</a>
                        </div>
                        <textarea x-model="form.notifiersStr"
                            class="w-full bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-xl p-4 text-gray-900 dark:text-white h-24 text-sm font-mono"
                            placeholder="twilio://accountSid:authToken@fromNumber/toNumber"></textarea>
                    </div>

                    <div x-show="isSecure" class="pt-4 border-t border-gray-200 dark:border-white/5 space-y-4">
                        <div class="flex justify-between items-center">
                            <label class="text-[10px] font-bold text-gray-500 uppercase block">Push Reminder
                                Threshold</label>
                            <span class="text-xs font-black text-indigo-500 dark:text-indigo-400"
                                x-text="reminderSteps[form.reminderIndex].label === 'Off' ? 'Disabled' : reminderSteps[form.reminderIndex].label + ' before'"></span>
                        </div>
                        <div class="px-1 py-4">
                            <input type="range" min="0" :max="reminderSteps.length - 1" step="1"
                                x-model="form.reminderIndex" @input="updateReminderFromSlider()"
                                class="w-full h-1.5 bg-gray-200 dark:bg-white/10 rounded-lg appearance-none cursor-pointer accent-indigo-500">
                            <div class="flex justify-between mt-4">
                                <template x-for="(step, index) in reminderSteps" :key="index">
                                    <span class="text-[7px] font-bold uppercase"
                                        :class="form.reminderIndex == index ? 'text-indigo-500 dark:text-indigo-400' : 'text-gray-400 dark:text-gray-600'"
                                        x-text="step.label"></span>
                                </template>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer"><input x-model="form.deleteAfterTriggered"
                                type="checkbox"
                                class="rounded bg-gray-200 dark:bg-white/5 text-indigo-500 border-gray-300 dark:border-transparent"><span
                                class="text-[10px] text-gray-500 dark:text-gray-400">Auto-Delete</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input x-model="form.encrypted"
                                type="checkbox"
                                class="rounded bg-gray-200 dark:bg-white/5 text-indigo-500 border-gray-300 dark:border-transparent"><span
                                class="text-[10px] text-gray-500 dark:text-gray-400">Encrypted</span></label>
                    </div>
                </div>
                <button type="submit"
                    class="w-full mt-8 bg-indigo-600 text-white font-black py-4 rounded-2xl transition-transform active:scale-95">SAVE</button>
            </form>
        </div>
    </div>

    <script>
        // PKCE helpers (must be defined before Alpine)
        function generateCodeVerifier() {
            const arr = new Uint8Array(32);
            crypto.getRandomValues(arr);
            return btoa(String.fromCharCode(...arr)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }
        async function generateCodeChallenge(verifier) {
            const data = new TextEncoder().encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }
        function parseJwt(token) {
            try {
                const base64 = token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/');
                return JSON.parse(atob(base64));
            } catch { return null; }
        }

        function app() {
            return {
                sw: null,
                switches: [],
                baseUrl: '/api/v1', switches: [], openModal: false, editingId: null, now: Date.now(), resettingId: null,
                failureModalOpen: false, selectedFailureSw: null,
                isOnline: navigator.onLine,
                isSecure: window.isSecureContext || window.location.protocol === 'https:',
                showInsecureWarning: true,
                notifyStatus: ('Notification' in window) ? Notification.permission : 'unsupported',
                vapidPublicKey: '',
                darkMode: document.documentElement.classList.contains('dark'),

                // Auth state
                authEnabled: false,
                authReady: false,
                accessToken: null,
                userName: '',
                oidcConfig: null,
                providerName: 'your provider',
                authErrorOpen: false,
                authErrorMessage: '',

                // Location state
                locatingId: null,

                // Drag and Drop state
                draggingIndex: null,

                reminderSteps: [
                    { label: 'Off', value: '' },
                    { label: '5m', value: '5m' },
                    { label: '30m', value: '30m' },
                    { label: '1h', value: '1h' },
                    { label: '4h', value: '4h' },
                    { label: '8h', value: '8h' },
                    { label: '12h', value: '8h' },
                    { label: '24h', value: '24h' },
                    { label: '48h', value: '48h' }
                ],
                form: {
                    message: '',
                    checkInInterval: '24h',
                    notifiersStr: '',
                    deleteAfterTriggered: false,
                    encrypted: false,
                    reminderEnabled: false,
                    reminderThreshold: '',
                    reminderIndex: 0,
                    pushSubscription: null
                },

                updateReminderFromSlider() {
                    this.form.reminderThreshold = this.reminderSteps[this.form.reminderIndex].value;
                },

                toggleTheme() {
                    if (this.darkMode) {
                        document.documentElement.classList.remove('dark');
                        localStorage.theme = 'light';
                        this.darkMode = false;
                    } else {
                        document.documentElement.classList.add('dark');
                        localStorage.theme = 'dark';
                        this.darkMode = true;
                    }
                },

                async init() {
                    // Check auth configuration
                    try {
                        const authRes = await fetch(`${this.baseUrl}/auth/config`);
                        if (authRes.ok) {
                            const authConfig = await authRes.json();
                            this.authEnabled = authConfig.enabled;
                            if (this.authEnabled) {
                                // Derive provider name from issuer URL for the login button
                                const issuerUrl = authConfig.issuerUrl || '';
                                if (issuerUrl.includes('accounts.google.com')) {
                                    this.providerName = 'Google';
                                } else if (issuerUrl.includes('authentik') || issuerUrl.includes('/application/o/')) {
                                    this.providerName = 'Authentik';
                                } else {
                                    // Extract hostname as a fallback label
                                    try { this.providerName = new URL(issuerUrl).hostname; } catch { this.providerName = 'your provider'; }
                                }
                                // Fetch OIDC discovery (normalize trailing slash for cross-provider compatibility)
                                const issuer = authConfig.issuerUrl.endsWith('/') ? authConfig.issuerUrl : authConfig.issuerUrl + '/';
                                const discRes = await fetch(issuer + '.well-known/openid-configuration');
                                if (discRes.ok) {
                                    this.oidcConfig = await discRes.json();
                                    this.oidcConfig.clientId = authConfig.audience;
                                }
                                // Check for auth callback (code in URL)
                                const params = new URLSearchParams(window.location.search);
                                const code = params.get('code');
                                const returnedState = params.get('state');
                                if (code) {
                                    // Validate state parameter to prevent CSRF
                                    const savedState = sessionStorage.getItem('dms_oauth_state');
                                    if (!savedState || savedState !== returnedState) {
                                        console.error('OAuth state mismatch — possible CSRF');
                                        sessionStorage.removeItem('dms_oauth_state');
                                        sessionStorage.removeItem('dms_pkce_verifier');
                                    } else {
                                        sessionStorage.removeItem('dms_oauth_state');
                                        await this.exchangeCode(code);
                                    }
                                    window.history.replaceState({}, '', '/');
                                } else {
                                    // Try to restore token from sessionStorage
                                    const saved = sessionStorage.getItem('dms_access_token');
                                    if (saved) {
                                        const claims = parseJwt(saved);
                                        if (claims && claims.exp * 1000 > Date.now()) {
                                            this.accessToken = saved;
                                            this.userName = claims.preferred_username || claims.name || claims.email || claims.sub || '';
                                        } else {
                                            sessionStorage.removeItem('dms_access_token');
                                            sessionStorage.removeItem('dms_id_token');
                                        }
                                    }
                                }
                            }
                        }
                    } catch (e) {
                        console.error("Auth config fetch failed", e);
                    }
                    this.authReady = true;

                    // If auth required but not logged in, stop here
                    if (this.authEnabled && !this.accessToken) return;

                    // Setup Connection Listeners
                    window.addEventListener('online', async () => {
                        // Add small delay to ensure server is ready
                        await new Promise(resolve => setTimeout(resolve, 500));
                        await this.getSw();
                    });
                    window.addEventListener('offline', () => { this.isOnline = false; });

                    // Fetch VAPID Key from server
                    try {
                        const res = await fetch(`${this.baseUrl}/vapid`, { headers: this.authHeaders() });
                        if (res.ok) {
                            this.vapidPublicKey = (await res.text()).trim();
                            this.isOnline = true;
                        }
                    } catch (e) {
                        console.error("Could not fetch VAPID key", e);
                    }

                    // Immediate Permission Request & SW Registration
                    if ('Notification' in window) {
                        this.notifyStatus = Notification.permission;
                        if (Notification.permission === 'default') {
                            this.notifyStatus = await Notification.requestPermission();
                        }
                        if (this.notifyStatus === 'granted' && 'serviceWorker' in navigator) {
                            try {
                                await navigator.serviceWorker.register('/sw.js');
                                console.log("Service Worker registered");
                            } catch (e) {
                                console.error("Service Worker registration failed", e);
                            }
                        }
                    }

                    // Background Sync for UI
                    setInterval(() => {
                        if ('Notification' in window) {
                            this.notifyStatus = Notification.permission;
                        }
                    }, 2000);

                    setInterval(() => {
                        this.now = Date.now();
                    }, 1000);

                    setInterval(() => {
                        if (!this.openModal && !this.resettingId) this.getSw();
                    }, 10000);

                    await this.getSw();
                },

                async requestNotify() {
                    if (!('Notification' in window)) return;
                    this.notifyStatus = await Notification.requestPermission();
                },

                isReminderEnabled(sw) {
                    if (!sw) return false; // Simple safety check for modal scope
                    return sw.reminderEnabled && sw.status !== 'disabled';
                },

                isExpiringSoon(deadline) {
                    const diff = ((deadline * 1000) - this.now) / 60000;
                    return diff > 0 && diff <= 30;
                },

                isPending(sw) {
                    return sw.status === 'active' && (sw.triggerAt * 1000 - this.now) <= 0;
                },

                getCountdown(deadline) {
                    const total = (deadline * 1000) - this.now;
                    if (isNaN(total) || total <= 0) return "00:00:00";

                    const s = Math.floor((total / 1000) % 60),
                        m = Math.floor((total / 60000) % 60),
                        h = Math.floor((total / 3600000) % 24),
                        d = Math.floor(total / 86400000);

                    return (d > 0 ? d + 'd ' : '') +
                        [h, m, s].map(v => v.toString().padStart(2, '0')).join(':');
                },

                async forcePermission() {
                    if (!('Notification' in window)) {
                        alert("Notifications are not supported on this browser.");
                        return;
                    }

                    if (Notification.permission === 'denied') {
                        alert("Notifications are blocked. Please enable them in your System Settings > Notifications.");
                        return;
                    }

                    const result = await Notification.requestPermission();
                    this.notifyStatus = result;

                    if (result === 'granted' && 'serviceWorker' in navigator) {
                        await navigator.serviceWorker.register('/sw.js');
                    }
                },

                async updateLocation(sw) {
                    if (!('geolocation' in navigator)) {
                        alert('Geolocation is not supported by your browser.');
                        return;
                    }
                    this.locatingId = sw.id;
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            try {
                                const lat = position.coords.latitude.toFixed(6);
                                const lng = position.coords.longitude.toFixed(6);
                                const mapsLink = `https://maps.google.com/?q=${lat},${lng}`;
                                const msg = sw.message.replace(/\s*—\s*https:\/\/maps\.google\.com\/\?q=[\d.\-,]+/, '');
                                const separator = msg.trim() ? ' — ' : '';

                                // Reuse the existing edit + save flow
                                this.editingId = sw.id;
                                this.form = {
                                    ...sw,
                                    notifiersStr: (sw.notifiers || []).join('\n'),
                                    message: msg.trim() + separator + mapsLink,
                                };
                                await this.saveSw();
                            } catch (e) {
                                console.error('Location update failed:', e);
                            } finally {
                                this.locatingId = null;
                            }
                        },
                        (error) => {
                            this.locatingId = null;
                            const messages = {
                                1: 'Location permission denied.',
                                2: 'Location unavailable.',
                                3: 'Location request timed out.'
                            };
                            alert(messages[error.code] || 'Unable to get location.');
                        },
                        { enableHighAccuracy: true, timeout: 10000 }
                    );
                },

                openCreateModal() {
                    this.editingId = null;
                    this.form = {
                        message: '',
                        checkInInterval: '24h',
                        notifiersStr: '',
                        deleteAfterTriggered: false,
                        encrypted: false,
                        reminderThreshold: '',
                        reminderIndex: 0,
                        pushSubscription: null
                    };
                    this.openModal = true;
                },

                openEditModal(sw) {
                    this.editingId = sw.id;
                    const rIndex = this.reminderSteps.findIndex(s => s.value === (sw.reminderThreshold || ''));
                    this.form = {
                        ...sw,
                        notifiersStr: (sw.notifiers || []).join('\n'),
                        reminderIndex: rIndex !== -1 ? rIndex : 0,
                        pushSubscription: sw.pushSubscription
                    };
                    this.openModal = true;
                },

                openFailureModal(sw) {
                    this.selectedFailureSw = sw;
                    this.failureModalOpen = true;
                },

                async deleteSw(id) {
                    if (confirm('Delete?')) {
                        await fetch(`${this.baseUrl}/switch/${id}`, { method: 'DELETE', headers: this.authHeaders() });
                        await this.getSw();
                    }
                },

                async disableSw(id) {
                    try {
                        await fetch(`${this.baseUrl}/switch/${id}/disable`, { method: 'POST', headers: this.authHeaders() });
                        await this.getSw();
                    } catch (e) { console.error("Disable failed", e); }
                },

                async getSw() {
                    // Prevent updates if user is currently dragging to avoid jumpiness
                    if (this.draggingIndex !== null) return;

                    try {
                        const r = await fetch(`${this.baseUrl}/switch`, { headers: this.authHeaders() });
                        if (r.status === 401 && this.authEnabled) {
                            await this.refreshToken();
                            return;
                        }
                        if (!r.ok) throw new Error("Server error");
                        const data = await r.json();

                        // Apply custom sort order
                        this.switches = this.sortSwitches(data);

                        this.isOnline = true;
                    } catch (e) {
                        this.isOnline = false;
                        console.error("Fetch failed:", e);
                    }
                },

                async resetSw(id) {
                    this.resettingId = id;
                    if ("vibrate" in navigator) navigator.vibrate([40, 40, 40]);

                    try {
                        const currentSub = await this.getSubscription();

                        const response = await fetch(`${this.baseUrl}/switch/${id}/reset`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', ...this.authHeaders() },
                            body: JSON.stringify({ pushSubscription: currentSub })
                        });

                        if (!response.ok) throw new Error("Reset failed");

                        await this.getSw();
                        setTimeout(() => { this.resettingId = null; }, 1000);
                    } catch (e) {
                        console.error("Reset failed:", e);
                        this.resettingId = null;
                    }
                },

                async saveSw() {
                    const notifiers = this.form.notifiersStr.split('\n').filter(s => s.trim());

                    let currentSub = null;
                    try {
                        currentSub = await this.getSubscription();
                    } catch (e) {
                        console.error("Failed to get subscription for save:", e);
                    }

                    const payload = {
                        ...this.form,
                        notifiers: notifiers,
                        pushSubscription: currentSub
                    };

                    if (!currentSub && payload.pushSubscription && Object.keys(payload.pushSubscription).length === 0) {
                        delete payload.pushSubscription;
                    };

                    const url = this.editingId ? `${this.baseUrl}/switch/${this.editingId}` : `${this.baseUrl}/switch`;

                    try {
                        const res = await fetch(url, {
                            method: this.editingId ? 'PUT' : 'POST',
                            body: JSON.stringify(payload),
                            headers: { 'Content-Type': 'application/json', ...this.authHeaders() }
                        });

                        if (res.ok) {
                            this.openModal = false;
                            await this.getSw();
                        } else {
                            const errData = await res.json();
                            alert(`Error: ${errData.message}`);
                        }
                    } catch (e) {
                        console.error("Save failed", e);
                    }
                },

                // Drag and Drop
                sortSwitches(data) {
                    const savedOrder = localStorage.getItem('switchOrder');
                    if (!savedOrder) return data;

                    try {
                        const orderIds = JSON.parse(savedOrder);
                        const orderMap = new Map(orderIds.map((id, index) => [id, index]));

                        return data.sort((a, b) => {
                            const indexA = orderMap.has(a.id) ? orderMap.get(a.id) : 9999;
                            const indexB = orderMap.has(b.id) ? orderMap.get(b.id) : 9999;
                            return indexA - indexB;
                        });
                    } catch (e) { return data; }
                },

                dragStart(e, index) {
                    this.draggingIndex = index;
                    e.dataTransfer.effectAllowed = 'move';
                    // Firefox requires data to be set for drag to work
                    e.dataTransfer.setData('text/plain', index);
                },

                drop(e, targetIndex) {
                    if (this.draggingIndex === null) return;

                    const item = this.switches[this.draggingIndex];

                    // Remove from old position
                    this.switches.splice(this.draggingIndex, 1);
                    // Insert at new position
                    this.switches.splice(targetIndex, 0, item);

                    this.draggingIndex = null;

                    // Save new order to localStorage
                    const newOrder = this.switches.map(s => s.id);
                    localStorage.setItem('switchOrder', JSON.stringify(newOrder));
                },

                dragEnd() {
                    this.draggingIndex = null;
                },

                async getSubscription() {
                    if (this.isSecure && 'serviceWorker' in navigator && 'Notification' in window && Notification.permission === 'granted') {
                        try {
                            const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error('SW timeout')), 3000));
                            const getSub = async () => {
                                const reg = await navigator.serviceWorker.ready;
                                let sub = await reg.pushManager.getSubscription();
                                if (!sub && this.vapidPublicKey) {
                                    sub = await reg.pushManager.subscribe({
                                        userVisibleOnly: true,
                                        applicationServerKey: Uint8Array.from(atob(this.vapidPublicKey.replace(/-/g, '+').replace(/_/g, '/')), c => c.charCodeAt(0))
                                    });
                                }
                                return sub;
                            };
                            return await Promise.race([getSub(), timeout]);
                        } catch (e) {
                            console.error("Failed to get subscription:", e);
                        }
                    }
                    return null;
                },

                // Auth methods
                showAuthError(msg) {
                    this.authErrorMessage = msg;
                    this.authErrorOpen = true;
                },

                async login() {
                    if (!this.oidcConfig) {
                        this.showAuthError('Unable to reach the authentication provider. Please verify the server is running and try again.');
                        return;
                    }
                    // Reachability check before redirecting
                    try {
                        const check = await fetch(this.oidcConfig.authorization_endpoint, { method: 'HEAD', mode: 'no-cors' });
                    } catch (e) {
                        this.showAuthError('The authentication provider is currently unreachable. Please check your connection and try again.');
                        return;
                    }
                    const verifier = generateCodeVerifier();
                    const challenge = await generateCodeChallenge(verifier);
                    // Generate cryptographic state for CSRF protection
                    const stateArr = new Uint8Array(16);
                    crypto.getRandomValues(stateArr);
                    const state = btoa(String.fromCharCode(...stateArr)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
                    sessionStorage.setItem('dms_pkce_verifier', verifier);
                    sessionStorage.setItem('dms_oauth_state', state);
                    const params = new URLSearchParams({
                        response_type: 'code',
                        client_id: this.oidcConfig.clientId,
                        redirect_uri: window.location.origin + '/',
                        scope: 'openid email profile offline_access',
                        code_challenge: challenge,
                        code_challenge_method: 'S256',
                        state: state,
                        access_type: 'offline',
                    });
                    window.location.href = this.oidcConfig.authorization_endpoint + '?' + params.toString();
                },

                async exchangeCode(code) {
                    const verifier = sessionStorage.getItem('dms_pkce_verifier');
                    if (!verifier || !this.oidcConfig) return;
                    sessionStorage.removeItem('dms_pkce_verifier');
                    try {
                        const res = await fetch(this.oidcConfig.token_endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: new URLSearchParams({
                                grant_type: 'authorization_code',
                                code: code,
                                redirect_uri: window.location.origin + '/',
                                client_id: this.oidcConfig.clientId,
                                code_verifier: verifier,
                            }),
                        });
                        if (res.ok) {
                            const data = await res.json();
                            this.setTokens(data);
                        } else {
                            console.error("Token exchange failed", await res.text());
                        }
                    } catch (e) {
                        console.error("Token exchange error", e);
                    }
                },

                setTokens(data) {
                    // Prefer access_token if it's a JWT; fall back to id_token for providers
                    // like Google whose access tokens are opaque (not JWTs)
                    let bearerToken = data.access_token;
                    if (!parseJwt(bearerToken) && data.id_token) {
                        bearerToken = data.id_token;
                    }
                    this.accessToken = bearerToken;
                    sessionStorage.setItem('dms_access_token', bearerToken);
                    if (data.id_token) sessionStorage.setItem('dms_id_token', data.id_token);
                    if (data.refresh_token) sessionStorage.setItem('dms_refresh_token', data.refresh_token);
                    const claims = parseJwt(bearerToken);
                    this.userName = claims?.preferred_username || claims?.name || claims?.email || claims?.sub || '';
                    // Schedule token refresh before expiry
                    if (claims?.exp) {
                        const msUntilExpiry = (claims.exp * 1000) - Date.now() - 30000; // 30s before
                        if (msUntilExpiry > 0) {
                            clearTimeout(this._refreshTimer);
                            this._refreshTimer = setTimeout(() => this.refreshToken(), msUntilExpiry);
                        }
                    }
                },

                async refreshToken() {
                    const rt = sessionStorage.getItem('dms_refresh_token');
                    if (!rt || !this.oidcConfig) {
                        this.handleSessionExpired();
                        return;
                    }
                    try {
                        const res = await fetch(this.oidcConfig.token_endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: new URLSearchParams({
                                grant_type: 'refresh_token',
                                refresh_token: rt,
                                client_id: this.oidcConfig.clientId,
                            }),
                        });
                        if (res.ok) {
                            this.setTokens(await res.json());
                        } else {
                            this.handleSessionExpired();
                        }
                    } catch (e) {
                        console.error('Token refresh failed', e);
                        this.handleSessionExpired();
                    }
                },

                handleSessionExpired() {
                    sessionStorage.removeItem('dms_access_token');
                    sessionStorage.removeItem('dms_id_token');
                    sessionStorage.removeItem('dms_refresh_token');
                    this.accessToken = null;
                    this.userName = '';
                    this.switches = [];
                    // Re-trigger login automatically
                    this.login();
                },

                logout() {
                    clearTimeout(this._refreshTimer);
                    const idToken = sessionStorage.getItem('dms_id_token');
                    sessionStorage.removeItem('dms_access_token');
                    sessionStorage.removeItem('dms_id_token');
                    sessionStorage.removeItem('dms_refresh_token');
                    this.accessToken = null;
                    this.userName = '';
                    this.switches = [];
                    if (this.oidcConfig?.end_session_endpoint && idToken) {
                        const params = new URLSearchParams({
                            id_token_hint: idToken,
                            post_logout_redirect_uri: window.location.origin + '/',
                        });
                        window.location.href = this.oidcConfig.end_session_endpoint + '?' + params.toString();
                    }
                },

                authHeaders() {
                    if (this.accessToken) {
                        return { 'Authorization': 'Bearer ' + this.accessToken };
                    }
                    return {};
                }
            }
        }
    </script>
    <div x-show="notifyStatus === 'default' && (!authEnabled || accessToken)" x-transition:enter="transition ease-out duration-500"
        x-transition:enter-start="translate-y-20 opacity-0" x-transition:enter-end="translate-y-0 opacity-100"
        class="fixed bottom-6 left-4 right-4 z-[60] max-w-md mx-auto">
        <div
            class="bg-indigo-600 rounded-2xl p-4 shadow-2xl flex items-center justify-between gap-4 border border-indigo-400/30">
            <div class="flex items-center gap-3">
                <div class="bg-white/20 p-2 rounded-lg">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                </div>
                <div>
                    <p class="text-xs font-black uppercase tracking-wider text-white">Enable Reminders</p>
                    <p class="text-[10px] text-indigo-100 opacity-80">Don't miss your check-in window.</p>
                </div>
            </div>
            <button @click="forcePermission()"
                class="bg-white text-indigo-600 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg active:scale-95 transition-transform">
                Allow
            </button>
        </div>
    </div>

    <footer class="fixed bottom-0 left-0 right-0 z-30 pointer-events-none" x-show="!authEnabled || accessToken" x-cloak>
        <div class="text-center py-3">
            <a href="https://github.com/circa10a/dead-mans-switch" target="_blank" rel="noopener noreferrer"
                class="pointer-events-auto inline-flex items-center gap-1.5 text-[10px] font-medium text-gray-400 dark:text-gray-600 hover:text-gray-600 dark:hover:text-gray-400 transition-colors">
                <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/>
                </svg>
                circa10a/dead-mans-switch
            </a>
        </div>
    </footer>
</body>

</html>