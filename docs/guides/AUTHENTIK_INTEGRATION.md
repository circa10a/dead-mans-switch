# Authentik Integration Guide

## Table of Contents

- [Overview](#overview)
  - [User-Based Access Control](#user-based-access-control)
- [Prerequisites](#prerequisites)
- [Quick Start with Docker Compose](#quick-start-with-docker-compose)
  - [Option A: Fully Automated (No Authentik UI Required)](#option-a-fully-automated-no-authentik-ui-required)
  - [Option B: Manual Setup (via Authentik UI)](#option-b-manual-setup-via-authentik-ui)
- [CLI Authentication Commands](#cli-authentication-commands)
  - [Login](#login)
  - [Check Status](#check-status)
  - [Logout](#logout)
- [Configuration Reference](#configuration-reference)
  - [Environment Variables](#environment-variables)
  - [CLI Flags](#cli-flags)
  - [Issuer URL Format](#issuer-url-format)
- [Troubleshooting](#troubleshooting)
  - ["Public key not found for kid"](#public-key-not-found-for-kid)
  - ["Invalid issuer"](#invalid-issuer)
  - ["Invalid audience"](#invalid-audience)
  - ["Missing Authorization header"](#missing-authorization-header)
- [Disabling Authentication](#disabling-authentication)
- [References](#references)

Dead Man's Switch supports JWT authentication via [Authentik](https://goauthentik.io/). This guide will walk you through setting up Authentik and configuring Dead Man's Switch to use it for API, CLI and UI authentication.

## Overview

When authentication is enabled, all requests (API, CLI and UI) will require a valid JWT token issued by your Authentik instance. The token must be passed in the `Authorization` header using the `Bearer` scheme:

```
Authorization: Bearer <your-jwt-token>
```

### User-Based Access Control

With authentication enabled, each user can only see and manage their own switches. When you create a switch, it's automatically associated with your user account. The following user identifiers are supported (in order of preference):

1. Subject claim (`sub`)
2. Email claim (`email`)
3. Name claim (`name`)

If authentication is disabled, all switches are accessible using the default `admin` user.

## Prerequisites

- Docker and Docker Compose (for running Authentik)
- A Dead Man's Switch instance
- Basic understanding of OAuth2/JWT authentication

## Quick Start with Docker Compose

### Option A: Fully Automated (No Authentik UI Required)

The project includes a blueprint that preconfigures Authentik with an OAuth2 provider, application, and service account user. No manual UI steps needed.

#### 1. Start Authentik

```bash
docker compose -f ./deploy/docker-compose/authentik/docker-compose.yaml up -d
```

#### 2. Get the OAuth2 Credentials

Once the services are up, read the credentials file:

```bash
cat ./deploy/docker-compose/authentik/dms-credentials.env
```

Or check the container logs:

```bash
docker compose -f ./deploy/docker-compose/authentik/docker-compose.yaml logs authentik 2>&1 | grep -A5 "OAuth2 Configuration"
```

Output will look like:

```
═══════════════════════════════════════════════════════════════
  Authentik OAuth2 Configuration
═══════════════════════════════════════════════════════════════
  Client ID:     <auto-generated>
  Issuer URL:    http://localhost:9000/application/o/dead-mans-switch/
  Username:      dms-service-account
  Password:      <app-password-token>
═══════════════════════════════════════════════════════════════

Start dead-mans-switch with:

  go run . server \
    --auth-enabled \
    --auth-issuer-url "http://localhost:9000/application/o/dead-mans-switch/"
```

#### 3. Start Dead Man's Switch

Copy the printed command from the script output:

```bash
go run . server \
  --auth-enabled \
  --auth-issuer-url "http://localhost:9000/application/o/dead-mans-switch/"
```

#### 4. Login with the CLI

The blueprint creates a service account with credentials that are ready to use with the CLI:

```bash
# Source the credentials generated by the bootstrap script
source ./deploy/docker-compose/authentik/dms-credentials.env

# Login with the service account
dead-mans-switch auth login \
  --issuer-url "$ISSUER_URL" \
  --client-id "$CLIENT_ID" \
  --username "$DMS_USERNAME" \
  --password "$DMS_PASSWORD"
```

All following CLI commands automatically use the cached token:

```bash
# Create a switch (token is attached automatically)
dead-mans-switch switch create -m "test" -n "logger://" --url http://localhost:8080/api/v1

# List switches
dead-mans-switch switch get --url http://localhost:8080/api/v1
```

#### 5. Alternative: Get a Token with curl

If you prefer to manage tokens manually:

```bash
source ./deploy/docker-compose/authentik/dms-credentials.env

curl -X POST http://localhost:9000/application/o/token/ \
  -d grant_type=client_credentials \
  -d "client_id=$CLIENT_ID" \
  -d "username=$DMS_USERNAME" \
  -d "password=$DMS_PASSWORD" \
  -d scope=openid

# Use the token:
TOKEN="<access_token from above>"
curl -H "Authorization: Bearer $TOKEN" http://localhost:8080/api/v1/switch
```

### Option B: Manual Setup (via Authentik UI)

If you prefer manual control or need to customize the setup, follow these steps to recreate what the blueprint creates automatically.

#### 1. Set Up Authentik

Use the provided docker-compose file to spin up Authentik:

```bash
docker compose -f ./deploy/docker-compose/authentik/docker-compose.yaml up -d
```

This will start:
- Authentik server on `http://localhost:9000`
- Authentik worker
- PostgreSQL database
- Redis cache

Wait for services to be healthy (approximately 2-3 minutes):

```bash
docker compose -f ./deploy/docker-compose/authentik/docker-compose.yaml ps
```

#### 2. Access Authentik Admin Panel

1. Open `http://localhost:9000` in your browser
2. Log in with default credentials:
   - Username: `akadmin`
   - Password: `akadmin`

#### 3. Create an OAuth2/OpenID Provider

1. Navigate to **Applications** -> **Providers**
2. Click **Create** -> **OAuth2/OpenID Provider**
3. Configure the following:
   - **Name**: `Dead Man's Switch Provider`
   - **Authorization flow**: `default-provider-authorization-implicit-consent`
   - **Invalidation flow**: `default-provider-invalidation-flow`
   - **Client type**: **Public** (required for PKCE browser-based login)
   - **Redirect URIs/Origins (RegEx)**: Add `http://localhost:8080/` with **Strict** matching mode
   - **Signing Key**: `authentik Self-signed Certificate`
   - **Access code validity**: `seconds=600`
   - **Access token validity**: `seconds=86400` (1 day)
   - **Refresh token validity**: `seconds=2592000` (30 days)
4. Under **Advanced protocol settings**:
   - **Scopes**: Select `openid`, `email`, and `profile`
   - **Subject mode**: `Based on the hashed User ID`
   - **Issuer mode**: `Each provider has a different issuer, based on the application slug`
5. Click **Finish**
6. Note the **Client ID** — you'll need this to start the Dead Man's Switch server

#### 4. Create the Application

1. Navigate to **Applications** -> **Applications**
2. Click **Create**
3. Configure:
   - **Name**: `Dead Man's Switch`
   - **Slug**: `dead-mans-switch`
   - **Provider**: Select `Dead Man's Switch Provider` (the provider you just created)
   - **Policy engine mode**: `ANY, any policy must match to grant access`
4. Click **Create**

#### 5. Create a Service Account (Optional — for Machine-to-Machine Access)

1. Navigate to **Directory** -> **Users**
2. Click **Create Service Account** (or **Create** and set the type)
3. Configure:
   - **Username**: `dms-service-account`
   - **Name**: `Dead Man's Switch Service Account`
   - **Email**: `dms@localhost`
   - **User type**: `Service Account`
   - **Path**: `goauthentik.io/service-accounts`
4. Set the password (e.g., `dead-mans-switch-service-password`)
5. Click **Create**

#### 6. Create an API Token for the Service Account (Optional)

1. Navigate to **Directory** -> **Tokens & App passwords**
2. Click **Create**
3. Configure:
   - **Identifier**: `dms-service-token`
   - **User**: Select `dms-service-account`
   - **Intent**: `App password`
   - **Expiring**: Unchecked (non-expiring)
4. Click **Create**

#### 7. Configure Dead Man's Switch

Get the Client ID from the provider you created in Step 3, then start the server:

```bash
dead-mans-switch server \
  --auth-enabled \
  --auth-issuer-url "http://localhost:9000/application/o/dead-mans-switch/" \
  --auth-audience "YOUR_CLIENT_ID"
```

Or using environment variables:

```bash
export DEAD_MANS_SWITCH_AUTH_ENABLED=true
export DEAD_MANS_SWITCH_AUTH_ISSUER_URL="http://localhost:9000/application/o/dead-mans-switch/"
export DEAD_MANS_SWITCH_AUTH_AUDIENCE="YOUR_CLIENT_ID"
dead-mans-switch server
```

> [!NOTE]
> The `--auth-audience` should be set to the Client ID from your OAuth2 provider. If the provider uses a **public** client type.

#### 8. Test the Integration

**Browser login**: Open `http://localhost:8080` — you'll be redirected to Authentik to sign in via the PKCE flow.

**CLI login**:

```bash
dead-mans-switch auth login \
  --issuer-url "http://localhost:9000/application/o/dead-mans-switch/" \
  --client-id YOUR_CLIENT_ID \
  --username dms-service-account \
  --password YOUR_APP_PASSWORD_TOKEN

# Verify it works
dead-mans-switch switch get --url http://localhost:8080/api/v1
```

**Manual curl**:

```bash
curl -X POST http://localhost:9000/application/o/token/ \
  -d grant_type=client_credentials \
  -d client_id=YOUR_CLIENT_ID \
  -d username=dms-service-account \
  -d password=YOUR_APP_PASSWORD_TOKEN \
  -d scope=openid

TOKEN="<access_token from above>"
curl -H "Authorization: Bearer $TOKEN" http://localhost:8080/api/v1/switch
```

Success response:
```json
[]
```

Failure response (without token or invalid token):
```
HTTP 401 Unauthorized
Missing authorization header
```

## CLI Authentication Commands

The CLI provides built-in commands for authenticating with an OIDC provider. Tokens are cached locally in `~/.dead-mans-switch/credentials.json` and automatically attached to all following API requests.

### Login

```bash
source ./deploy/docker-compose/authentik/dms-credentials.env

dead-mans-switch auth login \
  --issuer-url "$ISSUER_URL" \
  --client-id "$CLIENT_ID" \
  --username "$DMS_USERNAME" \
  --password "$DMS_PASSWORD"
```

### Check Status

```bash
dead-mans-switch auth status
```

### Logout

```bash
dead-mans-switch auth logout
```

## Configuration Reference

### Environment Variables

- `DEAD_MANS_SWITCH_AUTH_ENABLED` - Enable JWT authentication (true/false)
- `DEAD_MANS_SWITCH_AUTH_ISSUER_URL` - Authentik OAuth2 issuer URL
- `DEAD_MANS_SWITCH_AUTH_AUDIENCE` - Expected JWT audience claim (optional)

### CLI Flags

```bash
dead-mans-switch server --help
```

Relevant flags:
- `--auth-enabled` - Enable JWT authentication
- `--auth-issuer-url` - Authentik OAuth2 issuer URL
- `--auth-audience` - Expected JWT audience claim (optional)

### Issuer URL Format

The issuer URL must point to your Authentik OAuth2 provider base path:

```
http://localhost:9000/application/o/SLUG/
```

Where `SLUG` is the slug you set when creating the application (e.g., `dead-mans-switch`).

## Troubleshooting

### "Public key not found for kid"

The server failed to fetch public keys from Authentik's JWKS endpoint. Check:

1. **Issuer URL is correct** - Verify the issuer URL matches your Authentik setup
2. **Network connectivity** - Ensure the server can reach Authentik's JWKS endpoint: `http://your-authentik:9000/application/o/YOUR_APP/`
3. **Authentik is running** - Check that Authentik services are healthy

### "Invalid issuer"

The token issuer doesn't match the configured issuer URL. Verify:

1. The token was generated from the correct Authentik instance
2. The issuer URL in your Dead Man's Switch config matches exactly (trailing slash matters)

### "Invalid audience"

The JWT audience claim doesn't match the configured audience. Either:

1. Ensure the token includes the correct audience claim
2. Remove the `--auth-audience` flag if audience validation isn't needed
3. Check your Authentik OAuth2 provider settings

### "Missing Authorization header"

API requests must include a valid JWT token in the Authorization header:

```
Authorization: Bearer <token>
```

## Disabling Authentication

To disable authentication and run without access control:

```bash
dead-mans-switch server
```

Or explicitly:

```bash
dead-mans-switch server --auth-enabled=false
```


## References

- [Authentik Documentation](https://docs.goauthentik.io/)
- [OAuth 2.0 Specification](https://tools.ietf.org/html/rfc6749)
- [JWT Specification](https://tools.ietf.org/html/rfc7519)
